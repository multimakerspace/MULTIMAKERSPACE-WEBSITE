{% extends "base.html" %}

{% block title %}Payment Management - Admin{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-credit-card text-primary"></i> Payment Management
                    </h2>
                    <p class="text-muted">Manage student payments and financial records</p>
                </div>
                <div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPaymentModal">
                        <i class="bi bi-plus-circle"></i> Record Payment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Total Revenue</h6>
                            <h2 class="mb-0">RM {{ "%.2f"|format(total_revenue) }}</h2>
                        </div>
                        <i class="bi bi-cash-stack fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Transactions</h6>
                            <h2 class="mb-0">{{ total_transactions }}</h2>
                        </div>
                        <i class="bi bi-receipt fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Total Classes</h6>
                            <h2 class="mb-0">{{ total_classes }}</h2>
                        </div>
                        <i class="bi bi-calendar-check fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> Filter Payments</h5>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('admin_payments') }}" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Student</label>
                    <input type="text" class="form-control" name="student" placeholder="Search student..." value="{{ student_filter }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Month</label>
                    <select class="form-select" name="month">
                        <option value="">All Months</option>
                        {% for month in months %}
                            <option value="{{ month }}" {% if month_filter == month %}selected{% endif %}>{{ month }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Year</label>
                    <select class="form-select" name="year">
                        <option value="">All Years</option>
                        {% for year in years %}
                            <option value="{{ year }}" {% if year_filter == year|string %}selected{% endif %}>{{ year }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Payment Method</label>
                    <select class="form-select" name="method">
                        <option value="">All Methods</option>
                        {% for method in payment_methods %}
                            <option value="{{ method }}" {% if method_filter == method %}selected{% endif %}>{{ method }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="bi bi-search"></i> Apply Filters
                    </button>
                    <a href="{{ url_for('admin_payments') }}" class="btn btn-secondary">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Payments Table -->
    <div class="card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-table"></i> Payment Records</h5>
            <span class="badge bg-primary">{{ payments|length }} Records</span>
        </div>
        <div class="card-body">
            {% if payments %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Student</th>
                                <th>Class Type</th>
                                <th>Classes</th>
                               <!-- <th>Remaining</th>-->
                                <th>Class Date</th>
                                <th>Payment Date</th>
                                <th>For Month</th>
                                <th>Method</th>
                                <th>Amount</th>
                                <th>Recorded By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in payments %}
                            <tr>
                                <td>
                                    <div>
                                        <strong>{{ payment.student_name }}</strong>
                                        <br>
                                        <small class="text-muted">@{{ payment.username }}</small>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-info text-dark">{{ payment.class_type }}</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-secondary">{{ payment.number_of_classes }}</span>
                                </td>
                                <!--
                                <td class="text-center">
                                    {% set remaining = payment.classes_remaining|default(0, true) %}
                                    {% if remaining > 0 %}
                                        <span class="badge bg-warning text-dark">{{ remaining }} left</span>
                                
                                    {% else %}
                                        <span class="badge bg-secondary">Used up</span>
                                    {% endif %}
                                 </td>
                                -->
                                <td>
                                    {% if payment.class_date %}
                                        {{ payment.class_date }}
                                    {% else %}
                                        <small class="text-muted">-</small>
                                    {% endif %}
                                </td>
                                <td>{{ payment.payment_date }}</td>
                                <td>{{ payment.payment_month }} {{ payment.payment_year }}</td>
                                <td>
                                    <span class="badge {% if payment.payment_method == 'Cash' %}bg-success{% else %}bg-primary{% endif %}">
                                        {{ payment.payment_method }}
                                    </span>
                                </td>
                                <td>
                                    <strong>RM {{ "%.2f"|format(payment.amount_paid) }}</strong>
                                </td>
                                <td>
                                    <small>{{ payment.recorded_by_name }}</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('student_payment_history', student_id=payment.user_id) }}" 
                                           class="btn btn-outline-info" title="View History">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <button type="button" class="btn btn-outline-warning" title="Edit Payment"
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editPaymentModal"
                                                data-id="{{ payment.id }}"
                                                data-user-id="{{ payment.user_id }}"
                                                data-student-name="{{ payment.student_name }}"
                                                data-class-type="{{ payment.class_type }}"
                                                data-number-of-classes="{{ payment.number_of_classes }}"
                                                data-class-date="{{ payment.class_date or '' }}"
                                                data-payment-date="{{ payment.payment_date }}"
                                                data-payment-month="{{ payment.payment_month }}"
                                                data-payment-year="{{ payment.payment_year }}"
                                                data-payment-method="{{ payment.payment_method }}"
                                                data-amount-paid="{{ payment.amount_paid }}"
                                                data-notes="{{ payment.notes or '' }}">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <form action="{{ url_for('delete_payment', payment_id=payment.id) }}" 
                                              method="POST" style="display: inline;">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" class="btn btn-outline-danger" 
                                                    onclick="return confirm('Are you sure you want to delete this payment record?')"
                                                    title="Delete">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 
                    No payment records found. Click "Record Payment" to add your first payment.
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Payment Modal -->
<div class="modal fade" id="addPaymentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-cash-stack"></i> Record New Payment
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('add_payment') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="row">
                        <!-- Student Selection -->
                        <div class="col-md-12 mb-3">
                            <label class="form-label fw-bold">Select Student <span class="text-danger">*</span></label>
                            <select class="form-select" name="user_id" required>
                                <option value="">-- Choose a student --</option>
                                {% for student in students %}
                                    <option value="{{ student.id }}">
                                        {{ student.full_name }} ({{ student.email }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Class Type -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Class Type <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="class_type" 
                                   list="class_type_suggestions" placeholder="Enter class type..." required>
                            <datalist id="class_type_suggestions">
                                <option value="Regular Class">
                                <option value="Private Session">
                                <option value="Workshop">
                                <option value="Holiday Program">
                                <option value="Trial Class">
                            </datalist>
                            <small class="text-muted">Type your own or pick from suggestions</small>
                        </div>
                        
                        <!-- Number of Classes -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Number of Classes <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" name="number_of_classes" 
                                   min="1" step="1" required>
                        </div>
                        
                        <!-- Class Date -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Class Date</label>
                            <input type="date" class="form-control" name="class_date">
                            <small class="text-muted">Date of the class session (optional)</small>
                        </div>
                        
                        <!-- Payment Date -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Payment Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" name="payment_date" 
                                   value="{{ current_year }}-01-01" required>
                        </div>
                        
                        <!-- Payment Month -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Payment For Month <span class="text-danger">*</span></label>
                            <select class="form-select" name="payment_month" required>
                                <option value="">-- Select month --</option>
                                {% for month in months %}
                                    <option value="{{ month }}" {% if month == current_month %}selected{% endif %}>{{ month }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Payment Year -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Payment Year <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" name="payment_year" 
                                   min="2020" max="2099" value="{{ current_year }}" required>
                            <small class="text-muted">Enter any year (2020 - 2099)</small>
                        </div>
                        
                        <!-- Payment Method -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Payment Method <span class="text-danger">*</span></label>
                            <select class="form-select" name="payment_method" required>
                                <option value="">-- Select method --</option>
                                {% for method in payment_methods %}
                                    <option value="{{ method }}">{{ method }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Amount Paid -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Amount Paid (RM) <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">RM</span>
                                <input type="number" class="form-control" name="amount_paid" 
                                       min="0" step="0.01" required>
                            </div>
                        </div>
                        
                        <!-- Notes -->
                        <div class="col-md-12 mb-3">
                            <label class="form-label fw-bold">Notes</label>
                            <textarea class="form-control" name="notes" rows="2" 
                                      placeholder="Optional notes about this payment"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Record Payment
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Payment Modal -->
<div class="modal fade" id="editPaymentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="bi bi-pencil-square"></i> Edit Payment Record
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editPaymentForm" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="row">
                        <!-- Student (read-only display) -->
                        <div class="col-md-12 mb-3">
                            <label class="form-label fw-bold">Student</label>
                            <input type="text" class="form-control" id="edit_student_name" readonly>
                            <input type="hidden" name="user_id" id="edit_user_id">
                        </div>
                        
                        <!-- Class Type -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Class Type <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="class_type" id="edit_class_type"
                                   list="edit_class_type_suggestions" placeholder="Enter class type..." required>
                            <datalist id="edit_class_type_suggestions">
                                <option value="Regular Class">
                                <option value="Private Session">
                                <option value="Workshop">
                                <option value="Holiday Program">
                                <option value="Trial Class">
                            </datalist>
                            <small class="text-muted">Type your own or pick from suggestions</small>
                        </div>
                        
                        <!-- Number of Classes -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Number of Classes <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" name="number_of_classes" id="edit_number_of_classes"
                                   min="1" step="1" required>
                        </div>
                        
                        <!-- Class Date -->
                        <div class="col-md-6 mb-3">
                           <label class="form-label fw-bold">Class Date</label>
                           <input type="date" class="form-control" name="class_date" id="edit_class_date">
                            <small class="text-muted">Date of the class session (optional)</small>
                        </div>
                        
                        <!-- Payment Date -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Payment Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" name="payment_date" id="edit_payment_date" required>
                        </div>
                        
                        <!-- Payment Month -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Payment For Month <span class="text-danger">*</span></label>
                            <select class="form-select" name="payment_month" id="edit_payment_month" required>
                                <option value="">-- Select month --</option>
                                {% for month in months %}
                                    <option value="{{ month }}">{{ month }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Payment Year -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Payment Year <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" name="payment_year" id="edit_payment_year"
                                   min="2020" max="2099" required>
                            <small class="text-muted">Enter any year (2020 - 2099)</small>
                        </div>
                        
                        <!-- Payment Method -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Payment Method <span class="text-danger">*</span></label>
                            <select class="form-select" name="payment_method" id="edit_payment_method" required>
                                <option value="">-- Select method --</option>
                                {% for method in payment_methods %}
                                    <option value="{{ method }}">{{ method }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Amount Paid -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Amount Paid (RM) <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">RM</span>
                                <input type="number" class="form-control" name="amount_paid" id="edit_amount_paid"
                                       min="0" step="0.01" required>
                            </div>
                        </div>
                        
                        <!-- Notes -->
                        <div class="col-md-12 mb-3">
                            <label class="form-label fw-bold">Notes</label>
                            <textarea class="form-control" name="notes" id="edit_notes" rows="2" 
                                      placeholder="Optional notes about this payment"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-save"></i> Update Payment
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.table td {
    vertical-align: middle;
}
.badge {
    font-size: 0.85rem;
    padding: 0.35rem 0.65rem;
}
</style>

<script>
// Populate Edit Payment Modal with data from the clicked row
document.addEventListener('DOMContentLoaded', function() {
    var editModal = document.getElementById('editPaymentModal');
    if (editModal) {
        editModal.addEventListener('show.bs.modal', function(event) {
            var button = event.relatedTarget;
            
            // Set form action URL
            var paymentId = button.getAttribute('data-id');
            var form = document.getElementById('editPaymentForm');
            form.action = '/admin/payments/edit/' + paymentId;
            
            // Populate fields
            document.getElementById('edit_student_name').value = button.getAttribute('data-student-name');
            document.getElementById('edit_user_id').value = button.getAttribute('data-user-id');
            document.getElementById('edit_class_type').value = button.getAttribute('data-class-type');
            document.getElementById('edit_number_of_classes').value = button.getAttribute('data-number-of-classes');
            document.getElementById('edit_class_date').value = button.getAttribute('data-class-date');
            document.getElementById('edit_payment_date').value = button.getAttribute('data-payment-date');
            document.getElementById('edit_payment_month').value = button.getAttribute('data-payment-month');
            document.getElementById('edit_payment_year').value = button.getAttribute('data-payment-year');
            document.getElementById('edit_payment_method').value = button.getAttribute('data-payment-method');
            document.getElementById('edit_amount_paid').value = button.getAttribute('data-amount-paid');
            document.getElementById('edit_notes').value = button.getAttribute('data-notes');
        });
    }
});
</script>
{% endblock %}