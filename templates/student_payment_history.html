{% extends "base.html" %}

{% block title %}{{ student.full_name }} - Payment History{% endblock %}

{% block content %}

<style>
:root {
    --orange-50: #fff7ed;
    --orange-100: #ffedd5;
    --orange-200: #fed7aa;
    --orange-300: #fdba74;
    --orange-400: #fb923c;
    --orange-500: #f97316;
    --orange-600: #ea580c;
    --orange-700: #c2410c;
    --orange-800: #9a3412;
    --orange-900: #7c2d12;
    --white: #ffffff;
    --cream: #fffcf7;
    --text-dark: #431407;
    --text-muted-pay: #78716c;
    --border-light: #fde8d0;
}

/* ======== HEADER BANNER ======== */
.pay-banner {
    background: linear-gradient(135deg, var(--orange-900) 0%, var(--orange-700) 40%, var(--orange-600) 70%, var(--orange-500) 100%);
    border-radius: 20px;
    padding: 28px 32px;
    color: var(--white);
    position: relative;
    overflow: hidden;
    margin-bottom: 24px;
    opacity: 0;
    transform: translateY(18px);
    animation: payFadeUp 0.6s ease 0.1s forwards;
}

.pay-banner::before {
    content: '';
    position: absolute;
    top: -40%; right: -10%;
    width: 260px; height: 260px;
    background: radial-gradient(circle, rgba(255,255,255,0.07) 0%, transparent 70%);
    border-radius: 50%;
}

.pay-banner h2 {
    font-size: 1.45rem;
    font-weight: 800;
    margin: 0 0 8px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.pay-banner .back-link {
    color: rgba(255,255,255,0.75);
    text-decoration: none;
    font-size: 0.85rem;
    font-weight: 500;
    transition: color 0.2s;
}

.pay-banner .back-link:hover { color: var(--white); }
.pay-banner .back-link i { margin-right: 4px; }

.pay-banner .banner-icon {
    font-size: 2.2rem;
    opacity: 0.15;
    position: absolute;
    right: 32px;
    top: 50%;
    transform: translateY(-50%);
}

.pay-banner .student-badges {
    display: flex;
    gap: 8px;
    margin-top: 10px;
    flex-wrap: wrap;
}

.pay-banner .s-badge {
    background: rgba(255,255,255,0.15);
    padding: 4px 12px;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: 500;
    backdrop-filter: blur(4px);
}

.pay-banner .s-badge i { margin-right: 5px; opacity: 0.7; }

@keyframes payFadeUp { to { opacity: 1; transform: translateY(0); } }

/* ======== STAT CARDS ======== */
.pay-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.pay-stat {
    background: var(--white);
    border-radius: 16px;
    padding: 22px 20px;
    border: 2px solid var(--orange-100);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    opacity: 0;
    transform: translateY(16px);
    animation: payFadeUp 0.5s ease forwards;
}

.pay-stat::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 4px;
    border-radius: 16px 16px 0 0;
}

.pay-stat:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(249,115,22,0.08);
}

.pay-stat .stat-label {
    font-size: 0.78rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.4px;
    margin-bottom: 4px;
}

.pay-stat .stat-value {
    font-size: 1.7rem;
    font-weight: 800;
    line-height: 1.1;
}

.pay-stat .stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;
}

.pay-stat.s-total::before { background: linear-gradient(90deg, var(--orange-400), var(--orange-500)); }
.pay-stat.s-total .stat-label { color: var(--orange-600); }
.pay-stat.s-total .stat-value { color: var(--orange-700); }
.pay-stat.s-total .stat-icon { background: rgba(249,115,22,0.1); color: var(--orange-500); }

.pay-stat.s-count::before { background: linear-gradient(90deg, #10b981, #34d399); }
.pay-stat.s-count .stat-label { color: #059669; }
.pay-stat.s-count .stat-value { color: #047857; }
.pay-stat.s-count .stat-icon { background: rgba(16,185,129,0.1); color: #10b981; }

.pay-stat.s-classes::before { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
.pay-stat.s-classes .stat-label { color: #2563eb; }
.pay-stat.s-classes .stat-value { color: #1d4ed8; }
.pay-stat.s-classes .stat-icon { background: rgba(59,130,246,0.1); color: #3b82f6; }

/* ======== INFO CARDS ======== */
.info-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.info-card {
    background: var(--white);
    border-radius: 14px;
    border: 2px solid var(--orange-100);
    padding: 18px 20px;
    display: flex;
    align-items: center;
    gap: 14px;
    transition: all 0.25s;
}

.info-card:hover {
    border-color: var(--orange-200);
    box-shadow: 0 4px 14px rgba(249,115,22,0.06);
}

.info-card .info-icon {
    width: 42px;
    height: 42px;
    border-radius: 10px;
    background: var(--orange-50);
    color: var(--orange-500);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    flex-shrink: 0;
}

.info-card small { color: var(--text-muted-pay); font-size: 0.78rem; font-weight: 600; }
.info-card .fw-bold { color: var(--text-dark); font-size: 0.92rem; }

/* ======== TABLE SECTION ======== */
.table-card {
    background: var(--white);
    border-radius: 16px;
    border: 2px solid var(--orange-100);
    overflow: hidden;
}

.table-card-header {
    padding: 16px 22px;
    background: var(--orange-50);
    border-bottom: 1px solid var(--border-light);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.table-card-header h5 {
    font-size: 1rem;
    font-weight: 700;
    color: var(--text-dark);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.table-card-header h5 i { color: var(--orange-500); }

.records-badge {
    background: var(--orange-500);
    color: var(--white);
    padding: 3px 12px;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: 600;
}

.table-card-body { padding: 0; }

/* Table */
.table-pay {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin: 0;
}

.table-pay thead th {
    background: var(--orange-50);
    color: var(--orange-800);
    font-weight: 700;
    font-size: 0.76rem;
    text-transform: uppercase;
    letter-spacing: 0.4px;
    padding: 12px 14px;
    border-bottom: 2px solid var(--orange-200);
    white-space: nowrap;
}

.table-pay tbody tr { transition: background 0.2s; }
.table-pay tbody tr:hover { background: var(--orange-50); }

.table-pay tbody td {
    padding: 14px;
    border-bottom: 1px solid #fef2e8;
    font-size: 0.88rem;
    color: #44403c;
    vertical-align: middle;
}

.table-pay tfoot td {
    padding: 14px;
    background: var(--orange-50);
    border-top: 2px solid var(--orange-200);
    font-size: 0.88rem;
}

/* Badges */
.badge-type {
    background: rgba(59,130,246,0.1);
    color: #2563eb;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 0.78rem;
    font-weight: 600;
}

.badge-class-count {
    background: var(--orange-100);
    color: var(--orange-700);
    padding: 3px 10px;
    border-radius: 6px;
    font-size: 0.78rem;
    font-weight: 700;
}

.badge-method {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 0.78rem;
    font-weight: 600;
}

.badge-method.cash { background: rgba(16,185,129,0.1); color: #059669; }
.badge-method.transfer { background: rgba(59,130,246,0.1); color: #2563eb; }
.badge-method.other { background: rgba(107,114,128,0.1); color: #4b5563; }

.badge-receipt {
    background: #f5f0eb;
    color: #78716c;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 0.78rem;
    font-weight: 500;
    border: 1px solid #e7e5e4;
}

.amount-value {
    font-weight: 700;
    color: #059669;
    font-size: 0.92rem;
}

/* Empty State */
.empty-state-pay {
    text-align: center;
    padding: 40px 24px;
}

.empty-state-pay i { font-size: 2rem; color: var(--orange-300); display: block; margin-bottom: 10px; }
.empty-state-pay p { color: var(--text-muted-pay); font-size: 0.9rem; margin: 0; }

/* Note Button */
.btn-note {
    padding: 4px 10px;
    border-radius: 8px;
    border: 1.5px solid var(--orange-200);
    background: var(--orange-50);
    color: var(--orange-700);
    font-size: 0.78rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-note:hover {
    background: var(--orange-100);
    border-color: var(--orange-300);
}

/* Delete Button */
.btn-del {
    padding: 5px 10px;
    border-radius: 8px;
    border: 1.5px solid #fecaca;
    background: #fef2f2;
    color: #dc2626;
    font-size: 0.82rem;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-del:hover {
    background: #fee2e2;
    border-color: #f87171;
}

/* Modal */
.modal-header-orange {
    background: linear-gradient(135deg, var(--orange-500), var(--orange-600));
    color: var(--white);
    border-bottom: none;
    border-radius: 0;
}

/* Responsive */
@media (max-width: 768px) {
    .pay-banner { padding: 22px 20px; }
    .pay-banner h2 { font-size: 1.25rem; }
    .pay-banner .banner-icon { display: none; }
    .pay-stats { grid-template-columns: 1fr; }
}
</style>

<div class="container-fluid py-2">

    <!-- ======== HEADER BANNER ======== -->
    <div class="pay-banner">
        <a href="{{ url_for('admin_payments') }}" class="back-link">
            <i class="fas fa-arrow-left"></i> Back to Payment Management
        </a>
        <h2>
            <i class="fas fa-user-graduate"></i> {{ student.full_name }}
        </h2>
        <div class="student-badges">
            <span class="s-badge"><i class="fas fa-envelope"></i> {{ student.email }}</span>
            <span class="s-badge"><i class="fas fa-at"></i> {{ student.username }}</span>
        </div>
        <i class="fas fa-receipt banner-icon"></i>
    </div>

    <!-- ======== STAT CARDS ======== -->
    <div class="pay-stats">
        <div class="pay-stat s-total" style="animation-delay: 0.15s;">
            <div>
                <div class="stat-label">Total Paid</div>
                <div class="stat-value">RM {{ "%.2f"|format(summary.total_amount|default(0, true)) }}</div>
            </div>
            <div class="stat-icon"><i class="fas fa-coins"></i></div>
        </div>
        <div class="pay-stat s-count" style="animation-delay: 0.25s;">
            <div>
                <div class="stat-label">Total Payments</div>
                <div class="stat-value">{{ summary.total_payments|default(0, true) }}</div>
            </div>
            <div class="stat-icon"><i class="fas fa-receipt"></i></div>
        </div>
        <div class="pay-stat s-classes" style="animation-delay: 0.35s;">
            <div>
                <div class="stat-label">Classes Purchased</div>
                <div class="stat-value">{{ summary.total_classes_purchased|default(0, true) }}</div>
            </div>
            <div class="stat-icon"><i class="fas fa-shopping-bag"></i></div>
        </div>
    </div>

    <!-- ======== INFO CARDS ======== -->
    <div class="info-row">
        <div class="info-card">
            <div class="info-icon"><i class="fas fa-clock"></i></div>
            <div>
                <small>Last Payment Date</small>
                <div class="fw-bold">
                    {% if summary.last_payment_date and summary.last_payment_date != 'Never' %}
                        {{ summary.last_payment_date }}
                    {% else %}
                        <span style="color: var(--text-muted-pay);">No payments yet</span>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="info-card">
            <div class="info-icon"><i class="fas fa-credit-card"></i></div>
            <div>
                <small>Payment Methods Used</small>
                <div class="fw-bold">{{ summary.payment_methods or 'N/A' }}</div>
            </div>
        </div>
    </div>

    <!-- ======== PAYMENT TABLE ======== -->
    <div class="table-card">
        <div class="table-card-header">
            <h5><i class="fas fa-table"></i> Payment Records</h5>
            <span class="records-badge">{{ payments|length }} Records</span>
        </div>
        <div class="table-card-body">
            {% if payments %}
                <div class="table-responsive">
                    <table class="table-pay">
                        <thead>
                            <tr>
                                <th>Payment Date</th>
                                <th>Class Type</th>
                                <th>Classes</th>
                                <th>For Month</th>
                                <th>Payment Method</th>
                                <th>Amount</th>
                                <th>Receipt</th>
                                <th>Recorded By</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in payments %}
                            <tr>
                                <td>
                                    <strong>{{ payment.payment_date }}</strong>
                                    <br><small style="color: var(--text-muted-pay);">{{ payment.created_at[:10] if payment.created_at else '' }}</small>
                                </td>
                                <td>
                                    <span class="badge-type">{{ payment.class_type }}</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge-class-count">{{ payment.number_of_classes }}</span>
                                </td>
                                <td>{{ payment.payment_month }} {{ payment.payment_year }}</td>
                                <td>
                                    <span class="badge-method {% if payment.payment_method == 'Cash' %}cash{% elif payment.payment_method == 'Online Transfer' %}transfer{% else %}other{% endif %}">
                                        {{ payment.payment_method }}
                                    </span>
                                </td>
                                <td>
                                    <span class="amount-value">RM {{ "%.2f"|format(payment.amount_paid) }}</span>
                                </td>
                                <td>
                                    <span class="badge-receipt">
                                        <i class="fas fa-receipt"></i> {{ payment.receipt_number or 'N/A' }}
                                    </span>
                                </td>
                                <td>
                                    <small style="color: var(--text-muted-pay);">{{ payment.recorded_by_name }}</small>
                                </td>
                                <td>
                                    {% if payment.notes %}
                                        <button type="button" class="btn-note" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#noteModal"
                                                data-note="{{ payment.notes }}"
                                                data-date="{{ payment.payment_date }}"
                                                title="Click to read full note">
                                            <i class="fas fa-comment-dots"></i> 
                                            {{ payment.notes[:20] }}{% if payment.notes|length > 20 %}...{% endif %}
                                        </button>
                                    {% else %}
                                        <small style="color: #d1ccc7;">â€”</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <form action="{{ url_for('delete_payment', payment_id=payment.id) }}" 
                                          method="POST" style="display: inline;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn-del" 
                                                onclick="return confirm('Are you sure you want to delete this payment record for {{ student.full_name }}?')"
                                                title="Delete Payment">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="2" class="text-end fw-bold" style="color: var(--text-dark);">Totals:</td>
                                <td class="text-center fw-bold" style="color: var(--orange-700);">{{ summary.total_classes_purchased|default(0, true) }}</td>
                                <td colspan="2"></td>
                                <td class="fw-bold" style="color: #059669; font-size: 1rem;">RM {{ "%.2f"|format(summary.total_amount|default(0, true)) }}</td>
                                <td colspan="4"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            {% else %}
                <div class="empty-state-pay">
                    <i class="fas fa-inbox"></i>
                    <p>No payment records found for {{ student.full_name }}.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Note Modal - UNCHANGED FUNCTIONALITY -->
<div class="modal fade" id="noteModal" tabindex="-1" aria-labelledby="noteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="border-radius: 16px; overflow: hidden; border: 2px solid var(--orange-100);">
            <div class="modal-header modal-header-orange">
                <h5 class="modal-title" id="noteModalLabel">
                    <i class="fas fa-comment-dots me-2"></i> Payment Note
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 20px 24px;">
                <small style="color: var(--text-muted-pay);" id="noteDate"></small>
                <hr style="border-color: var(--border-light);">
                <p id="noteContent" class="mb-0" style="white-space: pre-wrap; color: var(--text-dark);"></p>
            </div>
            <div class="modal-footer" style="border-top-color: var(--border-light);">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 10px;">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('noteModal').addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var note = button.getAttribute('data-note');
        var date = button.getAttribute('data-date');
        
        document.getElementById('noteContent').textContent = note;
        document.getElementById('noteDate').textContent = 'Payment Date: ' + date;
    });

    // Animate stat numbers
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.pay-stat .stat-value').forEach(function(el) {
            var text = el.textContent.trim();
            var match = text.match(/(RM\s*)?([\d.]+)/);
            if (!match) return;
            var prefix = match[1] || '';
            var target = parseFloat(match[2]);
            if (isNaN(target)) return;
            var isDecimal = text.includes('.');
            var duration = 1000;
            var start = performance.now();
            el.textContent = prefix + '0' + (isDecimal ? '.00' : '');
            
            function tick(now) {
                var p = Math.min((now - start) / duration, 1);
                var eased = 1 - Math.pow(1 - p, 3);
                var current = eased * target;
                el.textContent = prefix + (isDecimal ? current.toFixed(2) : Math.round(current));
                if (p < 1) requestAnimationFrame(tick);
            }
            requestAnimationFrame(tick);
        });
    });
</script>
{% endblock %}